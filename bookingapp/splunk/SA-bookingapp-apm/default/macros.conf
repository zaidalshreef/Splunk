# =============================================================================
# BookingApp APM - Search Macros
# =============================================================================

# =============================================================================
# Base Searches
# =============================================================================
[bookingapp_all]
definition = index=bookingapp
iseval = 0

[bookingapp_api]
definition = index=bookingapp sourcetype="bookingapp:api:json"
iseval = 0

[bookingapp_traefik]
definition = index=bookingapp sourcetype="traefik:access:json"
iseval = 0

[bookingapp_postgres]
definition = index=bookingapp sourcetype="postgresql:json"
iseval = 0

[bookingapp_redis]
definition = index=bookingapp sourcetype="redis:log"
iseval = 0

[bookingapp_containers]
definition = index=bookingapp sourcetype="docker:container:json"
iseval = 0

[bookingapp_metrics]
definition = index=bookingapp sourcetype="bookingapp:metrics"
iseval = 0

# =============================================================================
# APM Metrics
# =============================================================================
[bookingapp_error_rate]
definition = `bookingapp_api` | stats count as total, sum(is_error) as errors | eval error_rate=round((errors/total)*100, 2) | fields error_rate
iseval = 0

[bookingapp_avg_response_time]
definition = `bookingapp_api` http_url=* duration_ms>0 | stats avg(duration_ms) as avg_response_ms | eval avg_response_ms=round(avg_response_ms, 0) | fields avg_response_ms
iseval = 0

[bookingapp_p99_response_time]
definition = `bookingapp_api` http_url=* duration_ms>0 | stats perc99(duration_ms) as p99_response_ms | eval p99_response_ms=round(p99_response_ms, 0) | fields p99_response_ms
iseval = 0

[bookingapp_requests_per_min]
definition = `bookingapp_api` http_url=* | timechart span=1m count as requests_per_min
iseval = 0

[bookingapp_apdex(threshold)]
definition = `bookingapp_api` http_url=* duration_ms>0 | eval satisfied=if(duration_ms<=$threshold$, 1, 0), tolerating=if(duration_ms>$threshold$ AND duration_ms<=($threshold$*4), 1, 0) | stats count as total, sum(satisfied) as satisfied_count, sum(tolerating) as tolerating_count | eval apdex=round((satisfied_count + (tolerating_count/2))/total, 2) | fields apdex
iseval = 0
args = threshold

# =============================================================================
# Trace Correlation
# =============================================================================
[bookingapp_trace(trace_id)]
definition = `bookingapp_all` trace_id="$trace_id$" OR correlation_id="$trace_id$" | sort _time
iseval = 0
args = trace_id

[bookingapp_request(request_id)]
definition = `bookingapp_all` request_id="$request_id$" | sort _time
iseval = 0
args = request_id

# =============================================================================
# Error Analysis
# =============================================================================
[bookingapp_errors]
definition = `bookingapp_api` level=error OR level=fatal | eval error_msg=coalesce(error_message, message)
iseval = 0

[bookingapp_top_errors]
definition = `bookingapp_errors` | stats count by error_name, error_msg | sort -count | head 20
iseval = 0

[bookingapp_error_trend]
definition = `bookingapp_errors` | timechart span=5m count as errors by error_name
iseval = 0

# =============================================================================
# Database Performance
# =============================================================================
[bookingapp_slow_queries]
definition = `bookingapp_postgres` query_duration_ms>100 | table _time, db_user, query_duration_ms, sql_statement
iseval = 0

[bookingapp_db_connections]
definition = `bookingapp_postgres` | where match(message, "connection") | stats count by message
iseval = 0

# =============================================================================
# Cache Performance
# =============================================================================
[bookingapp_cache_stats]
definition = `bookingapp_redis` | stats count as operations by redis_command
iseval = 0

# =============================================================================
# Service Dependencies
# =============================================================================
[bookingapp_dependency_map]
definition = `bookingapp_api` | eval source_service=service_name, target_service=case(match(http_url, "redis"), "redis", match(http_url, "postgres"), "postgres", match(context, "HTTP"), "external", 1=1, "internal") | stats count by source_service, target_service
iseval = 0

