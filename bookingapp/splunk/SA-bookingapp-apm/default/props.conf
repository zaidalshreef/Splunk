# =============================================================================
# BookingApp APM - Splunk Props Configuration
# =============================================================================
# Splunk automatically parses JSON logs with KV_MODE = json
# All services configured for comprehensive APM monitoring

# =============================================================================
# NGINX Access Logs (JSON/KV format with full APM data)
# =============================================================================
# Log format includes: request_id, trace_id, correlation_id, client_ip, method,
# uri, http_status, request_time, upstream_response_time, upstream_addr, etc.
[nginx:access:json]
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%S%z
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 30
TRUNCATE = 0
category = Web

# Field aliases for common dashboard queries
FIELDALIAS-status = http_status AS status_code
FIELDALIAS-method_alias = method AS http_method
FIELDALIAS-client = client_ip AS src_ip
FIELDALIAS-backend = upstream_addr AS backend_server
FIELDALIAS-latency = request_time AS response_time_sec
FIELDALIAS-url_alias = uri AS http_url
FIELDALIAS-full_url = request_uri AS http_request_uri

# Calculated fields
EVAL-response_time_ms = round(tonumber(request_time) * 1000, 2)
EVAL-duration_ms = round(tonumber(request_time) * 1000, 2)
EVAL-upstream_time_ms = round(tonumber(upstream_response_time) * 1000, 2)
EVAL-is_error = if(tonumber(http_status) >= 400, 1, 0)
EVAL-is_slow = if(tonumber(request_time) > 1, 1, 0)
EVAL-response_category = case(tonumber(http_status)<300, "success", tonumber(http_status)<400, "redirect", tonumber(http_status)<500, "client_error", tonumber(http_status)>=500, "server_error", 1=1, "unknown")
EVAL-has_trace = if(isnotnull(trace_id) AND trace_id!="", 1, 0)
EVAL-service_name = "nginx"
EVAL-http_status_num = tonumber(http_status)

# =============================================================================
# NGINX Error Logs
# =============================================================================
[nginx:error]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y/%m/%d %H:%M:%S
category = Web

EXTRACT-nginx_error = ^(?<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+)#(?<tid>\d+): (?:\*(?<connection>\d+) )?(?<error_message>.+)$

EVAL-is_error = if(log_level IN ("error", "crit", "alert", "emerg"), 1, 0)
EVAL-is_warning = if(log_level == "warn", 1, 0)

# =============================================================================
# NestJS API JSON Logs (Flawless-API format)
# =============================================================================
[bookingapp:api:json]
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%:z
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 35
TRUNCATE = 0
category = Application

# Field aliases for common names
FIELDALIAS-level_alias = level AS log_level
FIELDALIAS-msg_alias = message AS log_message
FIELDALIAS-env_alias = env AS environment
FIELDALIAS-trace_alias = trace AS stack_trace

# Field aliases for nested HTTP fields to flat field names
FIELDALIAS-http_url = http.request.url AS http_url
FIELDALIAS-http_method = http.request.method AS http_method
FIELDALIAS-http_status = http.response.statusCode AS http_status
FIELDALIAS-http_ip = http.request.ip AS client_ip
FIELDALIAS-http_ua = http.request.userAgent AS user_agent
FIELDALIAS-trace_id = traceId AS trace_id
FIELDALIAS-span_id = spanId AS span_id
FIELDALIAS-correlation = correlationId AS correlation_id
FIELDALIAS-svc = metadata.service AS service_name

# Calculated fields for dashboards
EVAL-is_error = if(level=="error" OR level=="fatal", 1, 0)
EVAL-is_warning = if(level=="warn", 1, 0)
EVAL-duration_ms = tonumber(replace(coalesce('http.duration', "0ms"), "ms", ""))
EVAL-is_slow = if(duration_ms > 1000, 1, 0)
EVAL-response_category = case('http.response.statusCode'<300, "success", 'http.response.statusCode'<400, "redirect", 'http.response.statusCode'<500, "client_error", 'http.response.statusCode'>=500, "server_error", 1=1, "unknown")
EVAL-service = coalesce('metadata.service', "flawless-api")
EVAL-context = coalesce('metadata.context', "unknown")
EVAL-instance_id = coalesce(hostname, "unknown")
EVAL-error_type = if(level=="error", coalesce('error.name', 'error.type', "Unknown"), null())

# =============================================================================
# NextJS Web Logs
# =============================================================================
[bookingapp:web:json]
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3N%:z
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 35
category = Application

EVAL-is_error = if(level=="error" OR level=="fatal", 1, 0)
EVAL-service = "nextjs-web"

# =============================================================================
# PostgreSQL Logs
# =============================================================================
[postgresql:log]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%d %H:%M:%S.%3N %z
MAX_TIMESTAMP_LOOKAHEAD = 40
category = Database

# Extract PostgreSQL log fields
EXTRACT-postgres_main = ^(?<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+ \w+) \[(?<pid>\d+)\]: \[(?<session>\d+-\d+)\] user=(?<db_user>[^,]*),db=(?<database>[^,]*),app=(?<application>[^,]*),client=(?<client_ip>[^ ]*) (?<log_level>\w+):\s*(?<message>.*)$

EVAL-is_error = if(log_level IN ("ERROR", "FATAL", "PANIC"), 1, 0)
EVAL-is_warning = if(log_level == "WARNING", 1, 0)
EVAL-is_slow_query = if(match(message, "duration:") AND tonumber(replace(message, ".*duration: ([\d.]+) ms.*", "\1")) > 100, 1, 0)

# =============================================================================
# Redis Logs
# =============================================================================
[redis:log]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %d %b %Y %H:%M:%S.%3N
category = Cache

# Extract Redis log fields
EXTRACT-redis_main = ^(?<pid>\d+):(?<role>[XCSM])\s+(?<timestamp>\d+ \w+ \d+ \d+:\d+:\d+\.\d+)\s+(?<log_level_char>[\*\#\-\.])\s+(?<message>.+)$

EVAL-redis_level = case(log_level_char=="*", "notice", log_level_char=="#", "warning", log_level_char=="-", "verbose", 1=1, "debug")
EVAL-is_error = if(log_level_char=="#", 1, 0)
EVAL-redis_role_name = case(role=="X", "sentinel", role=="C", "cluster", role=="S", "slave", role=="M", "master", 1=1, "unknown")

# =============================================================================
# Docker Container JSON Logs
# =============================================================================
[docker:container:json]
KV_MODE = json
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%9NZ
TIME_PREFIX = "time":"
category = Container

FIELDALIAS-log_message = log AS container_log
FIELDALIAS-stream_type = stream AS log_stream

# =============================================================================
# Syslog
# =============================================================================
[syslog]
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %H:%M:%S
category = System

# =============================================================================
# Linux Auth Logs
# =============================================================================
[linux_secure]
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %H:%M:%S
category = Security

EXTRACT-auth_main = ^(?<timestamp>\w+ \d+ \d+:\d+:\d+) (?<host>\S+) (?<process>[^\[]+)\[(?<pid>\d+)\]: (?<message>.+)$
EVAL-is_failed_auth = if(match(message, "Failed|Invalid|authentication failure"), 1, 0)

# =============================================================================
# System Metrics - CPU
# =============================================================================
[cpu_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# System Metrics - Memory
# =============================================================================
[memory_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# System Metrics - Disk
# =============================================================================
[disk_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# System Metrics - Network
# =============================================================================
[network_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# System Metrics - Processes
# =============================================================================
[ps_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# Docker Container Metrics
# =============================================================================
[docker_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Container

# =============================================================================
# Linux Kernel Logs
# =============================================================================
[linux_kern]
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %H:%M:%S
category = System

# =============================================================================
# I/O Statistics
# =============================================================================
[iostat_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# Network Connections
# =============================================================================
[netstat_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# Open Files
# =============================================================================
[openfiles_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# User Sessions
# =============================================================================
[users_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Security

# =============================================================================
# Service Status
# =============================================================================
[services_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = System

# =============================================================================
# System Uptime
# =============================================================================
[uptime_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = System

# =============================================================================
# VMStat
# =============================================================================
[vmstat_metrics]
KV_MODE = auto
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = timestamp="
category = Metrics

# =============================================================================
# Linux Audit Logs
# =============================================================================
[linux_audit]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_FORMAT = %s
TIME_PREFIX = msg=audit\(
MAX_TIMESTAMP_LOOKAHEAD = 20
category = Security

EXTRACT-audit = ^type=(?<audit_type>\w+) msg=audit\((?<epoch_time>\d+\.\d+):(?<audit_id>\d+)\):\s*(?<audit_data>.*)$

# =============================================================================
# Bash History
# =============================================================================
[bash_history]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
category = Security

# =============================================================================
# DPKG/APT Logs
# =============================================================================
[dpkg]
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%d %H:%M:%S
category = System

[apt_history]
SHOULD_LINEMERGE = true
LINE_BREAKER = ([\r\n]+Start-Date:)
TIME_FORMAT = %Y-%m-%d %H:%M:%S
TIME_PREFIX = Start-Date:
category = System

# =============================================================================
# Cron Logs
# =============================================================================
[cron]
SHOULD_LINEMERGE = false
TIME_FORMAT = %b %d %H:%M:%S
category = System
