<form version="1.1" theme="dark">
    <label>CACHE PERFORMANCE</label>
    <description>Redis Operations - Memory Usage - Connection Monitoring - Key Statistics</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
    </fieldset>

    <!-- Cache Health Summary -->
    <row>
        <panel>
            <title>TOTAL LOG EVENTS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="redis:log" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>CONNECTIONS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="redis:log" "Accepted" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>DISCONNECTIONS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="redis:log" "Client closed connection" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>LATEST KEY COUNT</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="redis:log" "DB 0:" | rex "(?&lt;key_count&gt;\d+) keys" | stats latest(key_count) as keys</query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>WARNINGS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="redis:log" "#" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[1,10]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- Activity Charts -->
    <row>
        <panel>
            <title>REDIS ACTIVITY OVER TIME</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log"
| eval event_type=case(
    match(_raw, "Accepted"), "Connection",
    match(_raw, "Client closed"), "Disconnect",
    match(_raw, "DB \d+:"), "DB Status",
    1=1, "Other"
)
| timechart span=1m count by event_type
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">column</option>
                <option name="charting.chart.stackMode">stacked</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"Connection": "#53A051", "Disconnect": "#F8BE34", "DB Status": "#00D1B2", "Other": "#6699CC"}</option>
                <option name="height">300</option>
            </chart>
        </panel>
        <panel>
            <title>KEYS OVER TIME</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log" "DB 0:"
| rex "(?&lt;key_count&gt;\d+) keys"
| rex "\((?&lt;volatile_count&gt;\d+) volatile\)"
| timechart span=1m latest(key_count) as "Total Keys", latest(volatile_count) as "Volatile Keys"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"Total Keys": "#00D1B2", "Volatile Keys": "#FF6384"}</option>
                <option name="height">300</option>
            </chart>
        </panel>
    </row>

    <!-- Connection Details -->
    <row>
        <panel>
            <title>CLIENT CONNECTIONS</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log" ("Accepted" OR "Client closed")
| rex "Accepted (?&lt;client_addr&gt;[\d\.:]+)"
| rex "addr=(?&lt;client_addr2&gt;[\d\.:]+)"
| rex "id=(?&lt;conn_id&gt;\d+)"
| rex "cmd=(?&lt;last_cmd&gt;\w+)"
| eval client_ip=coalesce(client_addr, client_addr2)
| eval event=if(match(_raw, "Accepted"), "CONNECT", "DISCONNECT")
| eval time=strftime(_time, "%H:%M:%S")
| table time, event, client_ip, conn_id, last_cmd
| sort -_time
| head 100
| rename time as "Time", event as "Event", client_ip as "Client", conn_id as "Conn ID", last_cmd as "Last Command"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="count">20</option>
                <format type="color" field="Event">
                    <colorPalette type="map">{"CONNECT": #53A051, "DISCONNECT": #F8BE34}</colorPalette>
                </format>
            </table>
        </panel>
        <panel>
            <title>COMMANDS DISTRIBUTION</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log" "cmd="
| rex "cmd=(?&lt;redis_cmd&gt;\w+)"
| stats count by redis_cmd
| sort -count
| head 10
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">pie</option>
                <option name="charting.drilldown">none</option>
                <option name="height">300</option>
            </chart>
        </panel>
    </row>

    <!-- Redis Warnings/Errors -->
    <row>
        <panel>
            <title>REDIS WARNINGS/ERRORS</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log" "#"
| rex "\d{2}:\d{2}:\d{2}\.\d+ # (?&lt;warning_msg&gt;.+)$"
| eval time=strftime(_time, "%H:%M:%S")
| table time, warning_msg
| sort -_time
| head 20
| rename time as "Time", warning_msg as "Warning Message"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
            </table>
        </panel>
    </row>
</form>
