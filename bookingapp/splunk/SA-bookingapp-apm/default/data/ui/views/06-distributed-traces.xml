<form version="1.1" theme="dark">
    <label>DISTRIBUTED TRACES</label>
    <description>Request Tracing - Correlation Analysis - Service Dependencies - Latency Breakdown</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
        <input type="dropdown" token="status_filter" searchWhenChanged="true">
            <label>STATUS</label>
            <choice value="*">All</choice>
            <choice value="success">Success Only</choice>
            <choice value="error">Errors Only</choice>
            <choice value="slow">Slow Only (&gt;100ms)</choice>
            <default>*</default>
        </input>
        <input type="text" token="trace_search" searchWhenChanged="true">
            <label>SEARCH REQUEST ID</label>
            <default>*</default>
        </input>
    </fieldset>

    <!-- Trace Statistics -->
    <row>
        <panel>
            <title>TOTAL REQUESTS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id=*
| stats dc(request_id) as requests
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#1a1a2e","#53A051"]</option>
                <option name="rangeValues">[0]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>API TRACES</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="bookingapp:api:json" traceId=*
| stats dc(traceId) as traces
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#1a1a2e","#53A051"]</option>
                <option name="rangeValues">[0]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>ERROR REQUESTS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id=*
| eval status_num=tonumber(http_status)
| where status_num&gt;=400
| stats dc(request_id) as error_requests
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[10,50]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>AVG LATENCY</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_time=*
| eval latency_ms=tonumber(request_time)*1000
| stats avg(latency_ms) as avg_latency
| eval avg_latency=round(avg_latency, 0)
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[100,500]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- Request Distribution -->
    <row>
        <panel>
            <title>REQUEST LATENCY DISTRIBUTION</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_time=*
| eval latency_ms=tonumber(request_time)*1000
| eval duration_bucket=case(
    latency_ms&lt;10, "&lt;10ms",
    latency_ms&lt;50, "10-50ms",
    latency_ms&lt;100, "50-100ms",
    latency_ms&lt;200, "100-200ms",
    latency_ms&lt;500, "200-500ms",
    latency_ms&lt;1000, "500ms-1s",
    1=1, "&gt;1s"
)
| stats count by duration_bucket
| eval sort_order=case(duration_bucket="&lt;10ms", 1, duration_bucket="10-50ms", 2, duration_bucket="50-100ms", 3, duration_bucket="100-200ms", 4, duration_bucket="200-500ms", 5, duration_bucket="500ms-1s", 6, 1=1, 7)
| sort sort_order
| fields - sort_order
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">bar</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"count": "#7C4DFF"}</option>
                <option name="height">250</option>
            </chart>
        </panel>
        <panel>
            <title>REQUEST VOLUME OVER TIME</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json"
| timechart span=1m count as "Requests"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">area</option>
                <option name="charting.chart.nullValueMode">zero</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"Requests": "#00D1B2"}</option>
                <option name="height">250</option>
            </chart>
        </panel>
    </row>

    <!-- Request List -->
    <row>
        <panel>
            <title>REQUEST LIST</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id=*
| eval latency_ms=tonumber(request_time)*1000, status_num=tonumber(http_status)
| eval has_error=if(status_num&gt;=400, 1, 0)
| eval is_slow=if(latency_ms&gt;100, 1, 0)
| where ("$status_filter$"="*") OR 
    ("$status_filter$"="error" AND has_error=1) OR 
    ("$status_filter$"="success" AND has_error=0) OR
    ("$status_filter$"="slow" AND is_slow=1)
| search request_id=*$trace_search$*
| eval time=strftime(_time, "%H:%M:%S.%3N")
| eval latency_ms=round(latency_ms, 1)
| eval upstream_ms=round(tonumber(upstream_response_time)*1000, 1)
| table time, request_id, method, uri, http_status, latency_ms, upstream_ms, upstream_addr, client_ip
| sort -_time
| head 100
| rename time as "Time", request_id as "Request ID", method as "Method", uri as "Endpoint", http_status as "Status", latency_ms as "Latency (ms)", upstream_ms as "Backend (ms)", upstream_addr as "Backend", client_ip as "Client IP"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">row</option>
                <option name="count">25</option>
                <format type="color" field="Status">
                    <colorPalette type="expression">if(tonumber(value) &gt;= 500, "#DC4E41", if(tonumber(value) &gt;= 400, "#F8BE34", "#53A051"))</colorPalette>
                </format>
                <format type="color" field="Latency (ms)">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="100"></scale>
                </format>
                <drilldown>
                    <link target="_blank">07-trace-details?form.request_id=$row.Request ID$</link>
                </drilldown>
            </table>
        </panel>
    </row>

    <!-- API Trace List -->
    <row>
        <panel>
            <title>API TRACE LIST (WITH TRACE ID)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="bookingapp:api:json" traceId=*
| eval time=strftime(_time, "%H:%M:%S.%3N")
| eval endpoint=coalesce('http.request.url', "-")
| eval method=coalesce('http.request.method', "-")
| eval status=coalesce('http.response.statusCode', "-")
| eval context=coalesce('metadata.context', "-")
| table time, traceId, spanId, correlationId, context, method, endpoint, status, level, message
| sort -_time
| head 100
| rename time as "Time", traceId as "Trace ID", spanId as "Span ID", correlationId as "Correlation ID", context as "Context", method as "Method", endpoint as "Endpoint", status as "Status", level as "Level", message as "Message"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="count">25</option>
                <option name="wrap">true</option>
                <format type="color" field="Level">
                    <colorPalette type="map">{"error": #DC4E41, "fatal": #B83C32, "warn": #F8BE34, "info": #53A051, "debug": #6699CC}</colorPalette>
                </format>
            </table>
        </panel>
    </row>
</form>
