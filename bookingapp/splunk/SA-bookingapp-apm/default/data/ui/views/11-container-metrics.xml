<form version="1.1" theme="dark">
    <label>CONTAINER METRICS</label>
    <description>Docker Container Health - Resource Usage - Status</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
        <input type="dropdown" token="container" searchWhenChanged="true">
            <label>CONTAINER</label>
            <choice value="*">All Containers</choice>
            <default>*</default>
            <fieldForLabel>container</fieldForLabel>
            <fieldForValue>container</fieldForValue>
            <search>
                <query>index=bookingapp sourcetype="docker_metrics" metric_type="docker" | stats count by container | sort -count</query>
                <earliest>-1h</earliest>
            </search>
        </input>
    </fieldset>

    <!-- Container Overview -->
    <row>
        <panel>
            <title>RUNNING CONTAINERS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker_status" running=1
| stats dc(container) as containers
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#DC4E41","#53A051"]</option>
                <option name="rangeValues">[1]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>STOPPED CONTAINERS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker_status" running=0
| stats dc(container) as containers
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[0,1]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>TOTAL CPU USAGE</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| stats sum(cpu_percent) as total_cpu
| eval total_cpu=round(total_cpu, 1)
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[50,80]</option>
                <option name="unit">%</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>TOTAL MEMORY USAGE</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| stats sum(mem_percent) as total_mem
| eval total_mem=round(total_mem, 1)
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[50,80]</option>
                <option name="unit">%</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- CPU and Memory by Container -->
    <row>
        <panel>
            <title>CPU USAGE BY CONTAINER</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| where container="$container$" OR "$container$"="*"
| timechart span=1m avg(cpu_percent) by container limit=10
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">line</option>
                <option name="charting.chart.nullValueMode">zero</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.legend.placement">bottom</option>
                <option name="charting.axisTitleY.text">CPU %</option>
                <option name="height">300</option>
            </chart>
        </panel>
        <panel>
            <title>MEMORY USAGE BY CONTAINER</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| where container="$container$" OR "$container$"="*"
| timechart span=1m avg(mem_percent) by container limit=10
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">area</option>
                <option name="charting.chart.stackMode">stacked</option>
                <option name="charting.chart.nullValueMode">zero</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.legend.placement">bottom</option>
                <option name="charting.axisTitleY.text">Memory %</option>
                <option name="height">300</option>
            </chart>
        </panel>
    </row>

    <!-- Current Container Stats -->
    <row>
        <panel>
            <title>CONTAINER RESOURCE USAGE</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| where container="$container$" OR "$container$"="*"
| stats latest(cpu_percent) as cpu, latest(mem_percent) as mem, latest(mem_used) as mem_used, latest(mem_limit) as mem_limit, latest(pids) as pids by container
| eval cpu=round(cpu, 2)
| eval mem=round(mem, 2)
| sort -cpu
| rename container as "Container", cpu as "CPU %", mem as "Memory %", mem_used as "Memory Used", mem_limit as "Memory Limit", pids as "PIDs"
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="drilldown">none</option>
                <format type="color" field="CPU %">
                    <colorPalette type="expression">if(value > 50, "#DC4E41", if(value > 20, "#F8BE34", "#53A051"))</colorPalette>
                </format>
                <format type="color" field="Memory %">
                    <colorPalette type="expression">if(value > 80, "#DC4E41", if(value > 50, "#F8BE34", "#53A051"))</colorPalette>
                </format>
            </table>
        </panel>
    </row>

    <!-- Container Status -->
    <row>
        <panel>
            <title>CONTAINER STATUS</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker_status"
| where container="$container$" OR "$container$"="*"
| stats latest(status) as status, latest(image) as image, latest(health) as health by container
| sort container
| rename container as "Container", status as "Status", image as "Image", health as "Health"
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="drilldown">none</option>
                <format type="color" field="Health">
                    <colorPalette type="map">{"running": #53A051, "stopped": #DC4E41}</colorPalette>
                </format>
            </table>
        </panel>
    </row>

    <!-- Network and Block IO -->
    <row>
        <panel>
            <title>NETWORK I/O BY CONTAINER</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| where container="$container$" OR "$container$"="*"
| stats latest(net_in) as net_in, latest(net_out) as net_out by container
| sort container
| rename container as "Container", net_in as "Network In", net_out as "Network Out"
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="drilldown">none</option>
            </table>
        </panel>
        <panel>
            <title>BLOCK I/O BY CONTAINER</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="docker_metrics" metric_type="docker"
| where container="$container$" OR "$container$"="*"
| stats latest(block_in) as block_in, latest(block_out) as block_out by container
| sort container
| rename container as "Container", block_in as "Block Read", block_out as "Block Write"
                    </query>
                    <earliest>-5m</earliest>
                    <latest>now</latest>
                </search>
                <option name="drilldown">none</option>
            </table>
        </panel>
    </row>
</form>
