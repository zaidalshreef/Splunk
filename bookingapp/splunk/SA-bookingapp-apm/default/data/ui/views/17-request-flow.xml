<form version="1.1" theme="dark">
    <label>REQUEST FLOW</label>
    <description>Full Request Timing Breakdown - See where time is spent in NGINX, Backend, Database, and Cache</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
        <input type="text" token="request_id" searchWhenChanged="true">
            <label>REQUEST ID</label>
            <default>*</default>
        </input>
    </fieldset>

    <!-- Request Summary -->
    <row>
        <panel>
            <title>REQUEST SUMMARY</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval total_ms=round(tonumber(request_time)*1000, 2)
| eval backend_ms=round(tonumber(upstream_response_time)*1000, 2)
| eval connect_ms=round(tonumber(upstream_connect_time)*1000, 2)
| eval header_ms=round(tonumber(upstream_header_time)*1000, 2)
| eval nginx_overhead_ms=round(total_ms - backend_ms, 2)
| eval time_display=strftime(_time, "%Y-%m-%d %H:%M:%S.%3N")
| table time_display, request_id, method, request_uri, http_status, total_ms, nginx_overhead_ms, backend_ms, connect_ms, header_ms, upstream_addr, client_ip, http_user_agent, bytes_sent, body_bytes_sent
| rename time_display as "Timestamp", request_id as "Request ID", method as "Method", request_uri as "Full URI", http_status as "Status", total_ms as "Total (ms)", nginx_overhead_ms as "NGINX Overhead (ms)", backend_ms as "Backend (ms)", connect_ms as "Connect (ms)", header_ms as "Header (ms)", upstream_addr as "Backend Server", client_ip as "Client IP", http_user_agent as "User Agent", bytes_sent as "Bytes Sent", body_bytes_sent as "Body Bytes"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
            </table>
        </panel>
    </row>

    <!-- Timing Breakdown Visual -->
    <row>
        <panel>
            <title>TOTAL TIME</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval total_ms=round(tonumber(request_time)*1000, 2)
| table total_ms
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[100,500]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>NGINX OVERHEAD</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval total_ms=tonumber(request_time)*1000, backend_ms=tonumber(upstream_response_time)*1000
| eval nginx_ms=round(total_ms - backend_ms, 2)
| table nginx_ms
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[5,20]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
                <option name="underLabel">Proxy Processing</option>
            </single>
        </panel>
        <panel>
            <title>CONNECTION SETUP</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval connect_ms=round(tonumber(upstream_connect_time)*1000, 2)
| table connect_ms
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[1,5]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
                <option name="underLabel">TCP Connect</option>
            </single>
        </panel>
        <panel>
            <title>BACKEND PROCESSING</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval backend_ms=round(tonumber(upstream_response_time)*1000, 2)
| table backend_ms
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[50,200]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
                <option name="underLabel">API Response Time</option>
            </single>
        </panel>
        <panel>
            <title>HTTP STATUS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| table http_status
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[400,500]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- Timing Waterfall -->
    <row>
        <panel>
            <title>REQUEST TIMING WATERFALL</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval total_ms=tonumber(request_time)*1000
| eval backend_ms=tonumber(upstream_response_time)*1000
| eval connect_ms=tonumber(upstream_connect_time)*1000
| eval header_ms=tonumber(upstream_header_time)*1000
| eval nginx_overhead=total_ms - backend_ms
| eval backend_processing=backend_ms - header_ms
| eval header_wait=header_ms - connect_ms
| eval fields="1. NGINX Receive Request", value=round(nginx_overhead/3, 2)
| append [| makeresults | eval fields="2. TCP Connect", value=0 ]
| append [| makeresults | eval fields="3. Wait for Response", value=0 ]
| append [| makeresults | eval fields="4. Backend Processing", value=0 ]
| append [| makeresults | eval fields="5. NGINX Send Response", value=0 ]
| stats first(value) as time_ms by fields
| sort fields
| eval time_ms=case(
    fields="2. TCP Connect", $result.connect_ms$,
    fields="3. Wait for Response", $result.header_wait$,
    fields="4. Backend Processing", $result.backend_processing$,
    fields="5. NGINX Send Response", $result.nginx_overhead$/3,
    1=1, time_ms
)
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">bar</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"time_ms": "#7C4DFF"}</option>
                <option name="charting.axisTitleY.text">Time (ms)</option>
                <option name="height">250</option>
            </chart>
        </panel>
        <panel>
            <title>TIME DISTRIBUTION</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"
| eval total_ms=tonumber(request_time)*1000
| eval backend_ms=tonumber(upstream_response_time)*1000
| eval connect_ms=tonumber(upstream_connect_time)*1000
| eval nginx_overhead=round(total_ms - backend_ms, 1)
| eval backend_time=round(backend_ms, 1)
| eval connect_time=round(connect_ms, 1)
| stats first(nginx_overhead) as "NGINX Overhead", first(connect_time) as "Connection", first(backend_time) as "Backend"
| transpose
| rename column as "Component", "row 1" as "Time (ms)"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">pie</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"NGINX Overhead": "#6699CC", "Connection": "#00D1B2", "Backend": "#7C4DFF"}</option>
                <option name="height">250</option>
            </chart>
        </panel>
    </row>

    <!-- Related API Logs -->
    <row>
        <panel>
            <title>RELATED API LOGS (Around Request Time)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="bookingapp:api:json"
| eval time_display=strftime(_time, "%H:%M:%S.%3N")
| eval context=coalesce('metadata.context', "-")
| eval endpoint=coalesce('http.request.url', "-")
| eval method_val=coalesce('http.request.method', "-")
| eval status=coalesce('http.response.statusCode', "-")
| eval duration=coalesce('http.duration', "-")
| table time_display, level, context, method_val, endpoint, status, duration, message, traceId, spanId
| sort -_time
| head 50
| rename time_display as "Time", level as "Level", context as "Context", method_val as "Method", endpoint as "Endpoint", status as "Status", duration as "Duration", message as "Message", traceId as "Trace ID", spanId as "Span ID"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
                <option name="count">20</option>
                <format type="color" field="Level">
                    <colorPalette type="map">{"error": #DC4E41, "fatal": #B83C32, "warn": #F8BE34, "info": #53A051, "debug": #6699CC}</colorPalette>
                </format>
            </table>
        </panel>
    </row>

    <!-- Database Activity -->
    <row>
        <panel>
            <title>DATABASE ACTIVITY (PostgreSQL)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log"
| eval time_display=strftime(_time, "%H:%M:%S.%3N")
| rex field=message "duration: (?&lt;duration_ms&gt;[\d.]+) ms"
| rex field=message "statement: (?&lt;sql_query&gt;.+)"
| table time_display, log_level, db_user, database, duration_ms, sql_query, message
| sort -_time
| head 30
| rename time_display as "Time", log_level as "Level", db_user as "User", database as "Database", duration_ms as "Duration (ms)", sql_query as "Query", message as "Message"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
                <option name="count">10</option>
                <format type="color" field="Duration (ms)">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="100"></scale>
                </format>
            </table>
        </panel>
    </row>

    <!-- Redis Activity -->
    <row>
        <panel>
            <title>CACHE ACTIVITY (Redis)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="redis:log"
| eval time_display=strftime(_time, "%H:%M:%S.%3N")
| eval level=case(log_level_char=="*", "notice", log_level_char=="#", "warning", log_level_char=="-", "verbose", 1=1, "debug")
| table time_display, level, message
| sort -_time
| head 30
| rename time_display as "Time", level as "Level", message as "Message"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
                <option name="count">10</option>
                <format type="color" field="Level">
                    <colorPalette type="map">{"warning": #F8BE34, "notice": #53A051, "verbose": #6699CC, "debug": #999999}</colorPalette>
                </format>
            </table>
        </panel>
    </row>

    <!-- Raw NGINX Log -->
    <row>
        <panel>
            <title>RAW NGINX ACCESS LOG</title>
            <event>
                <search>
                    <query>index=bookingapp sourcetype="nginx:access:json" request_id="$request_id$"</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="count">10</option>
                <option name="list.drilldown">none</option>
                <option name="rowNumbers">true</option>
            </event>
        </panel>
    </row>
</form>

