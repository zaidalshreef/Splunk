<form version="1.1" theme="dark">
    <label>DATABASE PERFORMANCE</label>
    <description>PostgreSQL Connection Monitoring - Activity Analysis - Error Detection</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
        <input type="dropdown" token="log_level" searchWhenChanged="true">
            <label>LOG LEVEL</label>
            <choice value="*">All</choice>
            <choice value="ERROR">Errors Only</choice>
            <choice value="LOG">LOG</choice>
            <default>*</default>
        </input>
    </fieldset>

    <!-- Database Health Summary -->
    <row>
        <panel>
            <title>TOTAL LOG EVENTS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="postgresql:log" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>CONNECTIONS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="postgresql:log" "connection received" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>AUTHENTICATIONS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="postgresql:log" "connection authorized" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>DISCONNECTIONS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="postgresql:log" "disconnection" | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051"]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>ERRORS</title>
            <single>
                <search>
                    <query>index=bookingapp sourcetype="postgresql:log" (ERROR OR FATAL) | stats count</query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[1,10]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- Activity Charts -->
    <row>
        <panel>
            <title>DATABASE ACTIVITY OVER TIME</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log"
| eval event_type=case(
    match(_raw, "connection received"), "Connect",
    match(_raw, "connection authorized"), "Authorized",
    match(_raw, "disconnection"), "Disconnect",
    match(_raw, "ERROR|FATAL"), "Error",
    1=1, "Other"
)
| timechart span=1m count by event_type
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">column</option>
                <option name="charting.chart.stackMode">stacked</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"Connect": "#53A051", "Authorized": "#00D1B2", "Disconnect": "#F8BE34", "Error": "#DC4E41", "Other": "#6699CC"}</option>
                <option name="height">300</option>
            </chart>
        </panel>
        <panel>
            <title>CONNECTIONS BY USER</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log" "connection authorized"
| rex "user=(?&lt;db_user&gt;[^,]+)"
| stats count by db_user
| sort -count
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">pie</option>
                <option name="charting.drilldown">none</option>
                <option name="height">300</option>
            </chart>
        </panel>
    </row>

    <!-- Session Duration -->
    <row>
        <panel>
            <title>SESSION DURATIONS</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log" "disconnection"
| rex "session time: (?&lt;session_time&gt;[\d:\.]+)"
| rex "user=(?&lt;db_user&gt;[^,]+)"
| rex "database=(?&lt;db_name&gt;\w+)"
| eval time=strftime(_time, "%H:%M:%S")
| table time, db_user, db_name, session_time
| sort -_time
| head 50
| rename time as "Time", db_user as "User", db_name as "Database", session_time as "Session Duration"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
            </table>
        </panel>
        <panel>
            <title>CONNECTIONS BY DATABASE</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log" "connection authorized"
| rex "database=(?&lt;db_name&gt;\w+)"
| stats count by db_name
| sort -count
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">bar</option>
                <option name="charting.drilldown">none</option>
                <option name="height">300</option>
            </chart>
        </panel>
    </row>

    <!-- Connection Details -->
    <row>
        <panel>
            <title>CONNECTION ACTIVITY LOG</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log"
| rex "user=(?&lt;db_user&gt;[^,]+)"
| rex "db=(?&lt;db_name&gt;[^,]+)"
| rex "app=(?&lt;app_name&gt;[^,]+)"
| rex "client=(?&lt;client&gt;[^\]]+)"
| eval time=strftime(_time, "%H:%M:%S")
| eval event_type=case(
    match(_raw, "connection received"), "CONNECT",
    match(_raw, "connection authenticated"), "AUTH",
    match(_raw, "connection authorized"), "AUTHORIZED",
    match(_raw, "disconnection"), "DISCONNECT",
    match(_raw, "ERROR"), "ERROR",
    match(_raw, "FATAL"), "FATAL",
    1=1, "OTHER"
)
| where event_type="$log_level$" OR "$log_level$"="*"
| table time, event_type, db_user, db_name, app_name, client
| sort -_time
| head 100
| rename time as "Time", event_type as "Event", db_user as "User", db_name as "Database", app_name as "Application", client as "Client"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="count">20</option>
                <format type="color" field="Event">
                    <colorPalette type="map">{"CONNECT": #53A051, "AUTH": #6699CC, "AUTHORIZED": #00D1B2, "DISCONNECT": #F8BE34, "ERROR": #DC4E41, "FATAL": #B83C32, "OTHER": #999999}</colorPalette>
                </format>
            </table>
        </panel>
    </row>

    <!-- Errors -->
    <row>
        <panel>
            <title>DATABASE ERRORS</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="postgresql:log" (ERROR OR FATAL OR WARNING)
| rex "user=(?&lt;db_user&gt;[^,]+)"
| rex "db=(?&lt;db_name&gt;[^,]+)"
| eval log_level=case(
    match(_raw, "ERROR"), "ERROR",
    match(_raw, "FATAL"), "FATAL",
    match(_raw, "WARNING"), "WARNING",
    1=1, "UNKNOWN"
)
| eval time=strftime(_time, "%H:%M:%S")
| rex "(?:ERROR|FATAL|WARNING):\s+(?&lt;error_message&gt;.+)$"
| table time, log_level, db_user, db_name, error_message
| sort -_time
| head 50
| rename time as "Time", log_level as "Severity", db_user as "User", db_name as "Database", error_message as "Error Message"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <option name="wrap">true</option>
                <format type="color" field="Severity">
                    <colorPalette type="map">{"ERROR": #DC4E41, "FATAL": #B83C32, "WARNING": #F8BE34}</colorPalette>
                </format>
            </table>
        </panel>
    </row>
</form>
