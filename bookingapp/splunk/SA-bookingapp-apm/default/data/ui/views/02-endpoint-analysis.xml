<form version="1.1" theme="dark">
    <label>ENDPOINT ANALYSIS</label>
    <description>Individual Endpoint Performance - Error Rates - Latency Distribution - Click endpoints to see request details</description>

    <fieldset submitButton="false" autoRun="true">
        <input type="time" token="time" searchWhenChanged="true">
            <label>TIME RANGE</label>
            <default>
                <earliest>-1h</earliest>
                <latest>now</latest>
            </default>
        </input>
        <input type="dropdown" token="endpoint" searchWhenChanged="true">
            <label>ENDPOINT</label>
            <choice value="*">All Endpoints</choice>
            <default>*</default>
            <fieldForLabel>uri</fieldForLabel>
            <fieldForValue>uri</fieldForValue>
            <search>
                <query>index=bookingapp sourcetype="nginx:access:json" uri=* | stats count by uri | sort -count | head 50</query>
                <earliest>-1h</earliest>
            </search>
        </input>
        <input type="dropdown" token="method" searchWhenChanged="true">
            <label>METHOD</label>
            <choice value="*">All Methods</choice>
            <choice value="GET">GET</choice>
            <choice value="POST">POST</choice>
            <choice value="PUT">PUT</choice>
            <choice value="DELETE">DELETE</choice>
            <choice value="PATCH">PATCH</choice>
            <default>*</default>
        </input>
    </fieldset>

    <!-- Endpoint Stats -->
    <row>
        <panel>
            <title>TOTAL REQUESTS</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json"
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| stats count
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#1a1a2e","#53A051"]</option>
                <option name="rangeValues">[0]</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>ERROR RATE</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json"
| eval status_num=tonumber(http_status)
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| stats count as total, sum(eval(if(status_num&gt;=400, 1, 0))) as errors
| eval rate=if(total&gt;0, round((errors/total)*100, 2), 0)
| fields rate
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[1,5]</option>
                <option name="unit">%</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>AVG LATENCY</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_time=*
| eval latency_ms=tonumber(request_time)*1000
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*") AND latency_ms&gt;0
| stats avg(latency_ms) as avg | eval avg=round(avg,0) | fields avg
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[200,1000]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
            </single>
        </panel>
        <panel>
            <title>P99 LATENCY</title>
            <single>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_time=*
| eval latency_ms=tonumber(request_time)*1000
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*") AND latency_ms&gt;0
| stats perc99(latency_ms) as p99 | eval p99=round(p99,0) | fields p99
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="colorMode">block</option>
                <option name="rangeColors">["#53A051","#F8BE34","#DC4E41"]</option>
                <option name="rangeValues">[500,2000]</option>
                <option name="unit">ms</option>
                <option name="useColors">1</option>
            </single>
        </panel>
    </row>

    <!-- Throughput & Latency Over Time -->
    <row>
        <panel>
            <title>REQUESTS OVER TIME</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json"
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| timechart span=1m count as "Requests"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">area</option>
                <option name="charting.chart.nullValueMode">zero</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"Requests": "#00D1B2"}</option>
                <option name="height">250</option>
            </chart>
        </panel>
        <panel>
            <title>LATENCY BREAKDOWN (AVG)</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" request_time=* upstream_response_time!="-"
| eval total_ms=tonumber(request_time)*1000, upstream_ms=tonumber(upstream_response_time)*1000
| eval nginx_overhead_ms=total_ms - upstream_ms
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| timechart span=1m avg(nginx_overhead_ms) as "NGINX Overhead", avg(upstream_ms) as "Backend Processing"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">area</option>
                <option name="charting.chart.stackMode">stacked</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"NGINX Overhead": "#6699CC", "Backend Processing": "#7C4DFF"}</option>
                <option name="charting.axisTitleY.text">Latency (ms)</option>
                <option name="height">250</option>
            </chart>
        </panel>
    </row>

    <!-- Status Codes & Backend Distribution -->
    <row>
        <panel>
            <title>STATUS CODE DISTRIBUTION</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" http_status=*
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| stats count by http_status
| sort http_status
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">bar</option>
                <option name="charting.drilldown">none</option>
                <option name="height">250</option>
            </chart>
        </panel>
        <panel>
            <title>BACKEND SERVER DISTRIBUTION</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" upstream_addr!="-"
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| stats count by upstream_addr
| sort -count
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">pie</option>
                <option name="charting.drilldown">none</option>
                <option name="height">250</option>
            </chart>
        </panel>
    </row>

    <!-- Endpoint Table with Drilldown -->
    <row>
        <panel>
            <title>ENDPOINT BREAKDOWN (Click to see requests)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" uri=*
| eval latency_ms=tonumber(request_time)*1000, status_num=tonumber(http_status), upstream_ms=tonumber(upstream_response_time)*1000
| where (uri="$endpoint$" OR "$endpoint$"="*") AND (method="$method$" OR "$method$"="*")
| stats count as requests, 
    avg(latency_ms) as avg_total_ms,
    avg(upstream_ms) as avg_backend_ms,
    perc50(latency_ms) as p50_ms,
    perc95(latency_ms) as p95_ms,
    perc99(latency_ms) as p99_ms, 
    max(latency_ms) as max_ms, sum(eval(if(status_num&gt;=400, 1, 0))) as errors 
    by method, uri
| eval nginx_overhead_ms=round(avg_total_ms - avg_backend_ms, 1)
| eval error_rate=round((errors/requests)*100, 2)."%"
| eval avg_total_ms=round(avg_total_ms,0), avg_backend_ms=round(avg_backend_ms,0), p50_ms=round(p50_ms,0), p95_ms=round(p95_ms,0), p99_ms=round(p99_ms,0), max_ms=round(max_ms,0)
| sort -requests
| rename method as "Method", uri as "Endpoint", requests as "Requests", avg_total_ms as "Total (ms)", avg_backend_ms as "Backend (ms)", nginx_overhead_ms as "NGINX (ms)", p50_ms as "P50", p95_ms as "P95", p99_ms as "P99", max_ms as "Max", error_rate as "Error Rate"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">row</option>
                <format type="color" field="Error Rate">
                    <colorPalette type="expression">if(tonumber(replace(value, "%", "")) > 5, "#DC4E41", if(tonumber(replace(value, "%", "")) > 1, "#F8BE34", "#53A051"))</colorPalette>
                </format>
                <format type="color" field="P99">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="500"></scale>
                </format>
                <format type="color" field="Backend (ms)">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="100"></scale>
                </format>
                <drilldown>
                    <set token="selected_endpoint">$row.Endpoint$</set>
                    <set token="selected_method">$row.Method$</set>
                </drilldown>
            </table>
        </panel>
    </row>

    <!-- Request List (shown when endpoint is clicked) -->
    <row depends="$selected_endpoint$">
        <panel>
            <title>REQUESTS FOR $selected_method$ $selected_endpoint$ (Click to see timing breakdown)</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" uri="$selected_endpoint$" method="$selected_method$"
| eval total_ms=round(tonumber(request_time)*1000, 1)
| eval backend_ms=round(tonumber(upstream_response_time)*1000, 1)
| eval connect_ms=round(tonumber(upstream_connect_time)*1000, 1)
| eval header_ms=round(tonumber(upstream_header_time)*1000, 1)
| eval nginx_ms=round(total_ms - backend_ms, 1)
| eval time_display=strftime(_time, "%H:%M:%S.%3N")
| table time_display, request_id, http_status, total_ms, nginx_ms, backend_ms, connect_ms, header_ms, upstream_addr, client_ip, bytes_sent
| sort -_time
| head 100
| rename time_display as "Time", request_id as "Request ID", http_status as "Status", total_ms as "Total (ms)", nginx_ms as "NGINX (ms)", backend_ms as "Backend (ms)", connect_ms as "Connect (ms)", header_ms as "Header (ms)", upstream_addr as "Backend Server", client_ip as "Client IP", bytes_sent as "Bytes"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">row</option>
                <option name="count">20</option>
                <format type="color" field="Status">
                    <colorPalette type="expression">if(tonumber(value) >= 500, "#DC4E41", if(tonumber(value) >= 400, "#F8BE34", "#53A051"))</colorPalette>
                </format>
                <format type="color" field="Total (ms)">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="100"></scale>
                </format>
                <drilldown>
                    <link target="_blank">17-request-flow?form.request_id=$row.Request ID$&amp;form.time.earliest=$time.earliest$&amp;form.time.latest=$time.latest$</link>
                </drilldown>
            </table>
        </panel>
    </row>

    <!-- Timing Breakdown Chart (shown when endpoint is clicked) -->
    <row depends="$selected_endpoint$">
        <panel>
            <title>TIMING BREAKDOWN FOR $selected_method$ $selected_endpoint$</title>
            <chart>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" uri="$selected_endpoint$" method="$selected_method$"
| eval total_ms=tonumber(request_time)*1000
| eval backend_ms=tonumber(upstream_response_time)*1000
| eval connect_ms=tonumber(upstream_connect_time)*1000
| eval nginx_ms=total_ms - backend_ms
| stats avg(nginx_ms) as "NGINX Overhead", avg(connect_ms) as "Connection Setup", avg(backend_ms) as "Backend Processing"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="charting.chart">bar</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.fieldColors">{"NGINX Overhead": "#6699CC", "Connection Setup": "#00D1B2", "Backend Processing": "#7C4DFF"}</option>
                <option name="charting.axisTitleY.text">Time (ms)</option>
                <option name="height">200</option>
            </chart>
        </panel>
        <panel>
            <title>BACKEND SERVER PERFORMANCE</title>
            <table>
                <search>
                    <query>
index=bookingapp sourcetype="nginx:access:json" uri="$selected_endpoint$" method="$selected_method$" upstream_addr!="-"
| eval backend_ms=tonumber(upstream_response_time)*1000
| stats count as requests, avg(backend_ms) as avg_ms, perc95(backend_ms) as p95_ms, perc99(backend_ms) as p99_ms, max(backend_ms) as max_ms by upstream_addr
| eval avg_ms=round(avg_ms, 1), p95_ms=round(p95_ms, 1), p99_ms=round(p99_ms, 1), max_ms=round(max_ms, 1)
| sort -requests
| rename upstream_addr as "Backend", requests as "Requests", avg_ms as "Avg (ms)", p95_ms as "P95 (ms)", p99_ms as "P99 (ms)", max_ms as "Max (ms)"
                    </query>
                    <earliest>$time.earliest$</earliest>
                    <latest>$time.latest$</latest>
                </search>
                <option name="drilldown">none</option>
                <format type="color" field="P99 (ms)">
                    <colorPalette type="minMidMax" minColor="#53A051" midColor="#F8BE34" maxColor="#DC4E41"></colorPalette>
                    <scale type="minMidMax" midValue="100"></scale>
                </format>
            </table>
        </panel>
    </row>

    <!-- Clear selection button -->
    <row depends="$selected_endpoint$">
        <panel>
            <html>
                <div style="text-align: center; padding: 10px;">
                    <a href="#" class="btn" onclick="splunkjs.mvc.Components.getInstance('default').set('selected_endpoint', null); splunkjs.mvc.Components.getInstance('default').set('selected_method', null); return false;">Clear Selection</a>
                </div>
            </html>
        </panel>
    </row>
</form>
