services:
  web:
    container_name: web
    build:
      context: .
      dockerfile: ./nextjs
      args:
        API_KEY: ${API_KEY}
        NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL}
        NEXTAUTH_URL: ${NEXTAUTH_URL}
        NEXT_PUBLIC_API_URL: http://bookingapp-api-1:3000
        NEXT_PUBLIC_MEASUREMENT_ID: ${NEXT_PUBLIC_MEASUREMENT_ID}
        NEXT_PUBLIC_HOTJAR_ID: ${NEXT_PUBLIC_HOTJAR_ID}
        NEXT_PUBLIC_TABBY_PUBLIC_KEY: ${NEXT_PUBLIC_TABBY_PUBLIC_KEY}
        NEXT_PUBLIC_TABBY_MERCHANT_CODE: ${NEXT_PUBLIC_TABBY_MERCHANT_CODE}
        NEXT_PUBLIC_TABBY_API_KEY: ${NEXT_PUBLIC_TABBY_API_KEY}
        NEXT_PUBLIC_TABBY_API_URL: ${NEXT_PUBLIC_TABBY_API_URL}
        NEXT_PUBLIC_MOYASAR_API_KEY: ${NEXT_PUBLIC_MOYASAR_API_KEY}
        NEXT_PUBLIC_FARO_URL: http://10.10.10.105:12347/collect
        NEXT_PUBLIC_FARO_APP_NAME: next-frontend
        NEXT_PUBLIC_FARO_APP_NAMESPACE: flawless
        SKIP_ENV_VALIDATION: 1
        NEXT_PUBLIC_SKIP_ENV_VALIDATION: 1
    restart: unless-stopped
    ports:
      - 3001:3000
    environment:
      - NODE_ENV=development
      - SKIP_ENV_VALIDATION=1
      - NEXT_PUBLIC_SKIP_ENV_VALIDATION=1
      - REDIS_URL=redis://redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_RETRY_STRATEGY=1
      - API_KEY=${API_KEY}
      - NODE_OPTIONS=--max-old-space-size=1536
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
    env_file:
      - ./apps/web/.env
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:3000/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      start_interval: 5s
    volumes:
      - ./logs/web:/app/logs
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      service: "web"
      environment: "production"
    networks:
      - flawless-network

  migrate:
    build:
      context: .
      dockerfile: ./nestjs
    command: ["sh", "-c", "cd packages/database && npx prisma migrate deploy"]
    environment:
      - DATABASE_URL=postgresql://app:password@postgres:5432/app
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    networks:
      - flawless-network

  api:
    build:
      context: .
      dockerfile: ./nestjs
    restart: unless-stopped
    ports:
      - "5000:5000"
    depends_on:
      migrate:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
        restart: true
      redis:
        condition: service_healthy
        restart: true
    environment:
      - PORT=5000
      - REDIS_URL=redis://redis:6379
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - API_KEYS=${API_KEYS}
      - DATABASE_URL=postgresql://app:password@postgres:5432/app
      - NEW_DATABASE_URL=postgresql://app:password@postgres:5432/app
      - SKIP_AUTH_IN_DEV=true
      - NODE_ENV=production
      - LOG_FORMAT=json
    env_file:
      - ./apps/api/.env
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:5000/api/v1/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      start_interval: 5s
    volumes:
      - ./logs/api:/app/logs
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      service: "api"
      environment: "production"
    networks:
      - flawless-network

  postgres:
    image: postgres:17
    container_name: postgres_dev
    restart: unless-stopped
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: password
      POSTGRES_DB: app
      POSTGRES_HOST_AUTH_METHOD: trust
      POSTGRES_INITDB_ARGS: "--data-checksums"
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./logs/postgres:/var/log/postgresql
    command: 
      - "postgres"
      - "-c"
      - "log_destination=stderr"
      - "-c"
      - "logging_collector=on"
      - "-c"
      - "log_directory=/var/log/postgresql"
      - "-c"
      - "log_filename=postgresql-%Y-%m-%d.log"
      - "-c"
      - "log_statement=all"
      - "-c"
      - "log_connections=on"
      - "-c"
      - "log_disconnections=on"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U app -d app" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
      start_interval: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      service: "postgres"
      environment: "production"
    networks:
      - flawless-network

  redis:
    image: redis/redis-stack:latest
    container_name: redis_dev
    restart: unless-stopped
    ports:
      - 6379:6379
    volumes:
      - redis_dev_data:/data
      - ./logs/redis:/var/log/redis
    command: redis-stack-server --appendonly yes --save 60 1000 --maxmemory 2gb --maxmemory-policy noeviction --tcp-keepalive 300 --timeout 0 --maxclients 10000 --loglevel verbose
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
      start_interval: 5s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
    labels:
      service: "redis"
      environment: "production"
    networks:
      - flawless-network

  # ==========================================================================
  # Fluent Bit - Lightweight log collector for Splunk
  # ==========================================================================
  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit-splunk
    hostname: bookingapp
    restart: unless-stopped
    volumes:
      # Docker container logs
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      # Application logs
      - ./logs:/app/logs:ro
      # Fluent Bit config
      - ./fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./fluent-bit/parsers.conf:/fluent-bit/etc/parsers.conf:ro
      # DB for tracking read position
      - /var/log:/var/log
    networks:
      - flawless-network
    labels:
      service: "fluent-bit"
      environment: "production"

volumes:
  postgres_dev_data:
  redis_dev_data:

networks:
  flawless-network:
    name: flawless-network
    external: true

