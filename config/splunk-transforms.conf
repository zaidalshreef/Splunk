# =============================================================================
# Splunk Enterprise - Transforms Configuration
# =============================================================================
# Field extractions and sourcetype routing
# =============================================================================

# =============================================================================
# Docker Container JSON Log Extraction
# =============================================================================
# Docker logs are wrapped in JSON: {"log":"actual message","stream":"stdout","time":"..."}
# We want to extract just the "log" content as the main event

[docker_extract_message]
REGEX = "log":"(.+?)(?:\\n)?","stream":"(stdout|stderr)"
FORMAT = log_message::$1 stream::$2
WRITE_META = true

# =============================================================================
# Route NestJS JSON Logs to nestjs:json sourcetype
# =============================================================================
# NestJS logs contain: {"level":"info","message":"...","timestamp":"..."}

[docker_route_nestjs]
REGEX = "log":".*\{.*\\"level\\".*\\"message\\".*\\"timestamp\\"
DEST_KEY = MetaData:Sourcetype
FORMAT = sourcetype::nestjs:json

# =============================================================================
# Route NextJS Logs to nextjs:log sourcetype
# =============================================================================
# NextJS logs typically start with standard prefixes

[docker_route_nextjs]
REGEX = "log":".*(?:â–² Next\.js|ready started|info  -|warn  -|error -|GET |POST |PUT |DELETE )
DEST_KEY = MetaData:Sourcetype
FORMAT = sourcetype::nextjs:log

# =============================================================================
# HEC Docker Log Extraction
# =============================================================================
# Docker Splunk logging driver sends: {"line":"log message","source":"stdout","container_name":"..."}

[hec_extract_log]
REGEX = "line":"(.+?)"(?:,|})
FORMAT = log_message::$1
WRITE_META = true

# =============================================================================
# Container Name Lookup
# =============================================================================
[container_lookup]
filename = container_lookup.csv
max_matches = 1

