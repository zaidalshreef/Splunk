# =============================================================================
# Splunk Enterprise - Props Configuration
# =============================================================================
# Data parsing and field extraction rules
# =============================================================================

# =============================================================================
# Docker Container Logs (from file monitor - /var/lib/docker/containers/)
# =============================================================================
# Docker writes logs in JSON format: {"log":"message\n","stream":"stdout","time":"..."}
# We extract the clean log message and detect if it's JSON (NestJS) or plain text

[docker:container:json]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
TIME_PREFIX = "time":"
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%9N
MAX_TIMESTAMP_LOOKAHEAD = 40
TRUNCATE = 0

# Extract fields from Docker JSON wrapper
TRANSFORMS-docker = docker_extract_message

# Set sourcetype based on content (JSON vs plain text)
TRANSFORMS-route = docker_route_nestjs, docker_route_nextjs

# =============================================================================
# Docker HEC Logs (from Docker logging driver via HTTP Event Collector)
# =============================================================================
[docker:json]
SHOULD_LINEMERGE = false
KV_MODE = json
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%9NZ
MAX_TIMESTAMP_LOOKAHEAD = 40

# The Docker Splunk logging driver sends: container_name, source, line
# "line" contains the actual log message
TRANSFORMS-hec = hec_extract_log

# =============================================================================
# NestJS Application Logs (JSON structured)
# =============================================================================
[nestjs:json]
SHOULD_LINEMERGE = false
KV_MODE = json
TIME_FORMAT = %Y-%m-%dT%H:%M:%S.%3NZ
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 30

# =============================================================================
# NextJS Application Logs (mostly plain text with some JSON)
# =============================================================================
[nextjs:log]
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
MAX_TIMESTAMP_LOOKAHEAD = 30

# =============================================================================
# Docker Metrics (from collector script)
# =============================================================================
[docker:metrics]
KV_MODE = json
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 30

# =============================================================================
# System Logs
# =============================================================================
[syslog]
TIME_FORMAT = %b %d %H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 20
SHOULD_LINEMERGE = false
LINE_BREAKER = ([\r\n]+)
EXTRACT-syslog = ^(?<syslog_timestamp>\w{3}\s+\d+\s+\d+:\d+:\d+)\s+(?<syslog_host>\S+)\s+(?<syslog_process>\S+?)(\[(?<syslog_pid>\d+)\])?:\s+(?<syslog_message>.+)

[linux_secure]
TIME_FORMAT = %b %d %H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 20
SHOULD_LINEMERGE = false
EXTRACT-ssh_auth = Accepted\s+(?<auth_method>\S+)\s+for\s+(?<user>\S+)\s+from\s+(?<src_ip>\d+\.\d+\.\d+\.\d+)\s+port\s+(?<src_port>\d+)
EXTRACT-ssh_failed = Failed\s+(?<auth_method>\S+)\s+for\s+(?<user>\S+)\s+from\s+(?<src_ip>\d+\.\d+\.\d+\.\d+)\s+port\s+(?<src_port>\d+)
EXTRACT-ssh_invalid = Invalid user\s+(?<user>\S+)\s+from\s+(?<src_ip>\d+\.\d+\.\d+\.\d+)

[linux_kernel]
TIME_FORMAT = %b %d %H:%M:%S
MAX_TIMESTAMP_LOOKAHEAD = 20
SHOULD_LINEMERGE = false
EXTRACT-kernel = ^(?<kernel_timestamp>\w{3}\s+\d+\s+\d+:\d+:\d+)\s+(?<host>\S+)\s+kernel:\s+\[?\s*(?<kernel_time>[\d.]+)\]?\s*(?<kernel_message>.+)

[linux_audit]
SHOULD_LINEMERGE = false
TIME_FORMAT = %s.%3N
TIME_PREFIX = msg=audit\(
MAX_TIMESTAMP_LOOKAHEAD = 20

# =============================================================================
# Traefik Access Logs
# =============================================================================
[traefik:access]
KV_MODE = json
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%S
TIME_PREFIX = "time":"
MAX_TIMESTAMP_LOOKAHEAD = 30

# =============================================================================
# Network Security Metrics
# =============================================================================
[network:security]
KV_MODE = json
SHOULD_LINEMERGE = false
TIME_FORMAT = %Y-%m-%dT%H:%M:%SZ
TIME_PREFIX = "timestamp":"
MAX_TIMESTAMP_LOOKAHEAD = 30

